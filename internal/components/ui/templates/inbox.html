<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="{{.BasePath}}/" />
    <title>Inbox - OpenCloudMesh</title>
    <style>
      :root {
        --bg-dark: #0f1419;
        --bg-card: #1a1f26;
        --bg-hover: #22272e;
        --accent: #00d4aa;
        --accent-dim: #00a884;
        --text-primary: #e7e9ea;
        --text-secondary: #8899a6;
        --success: #00ba7c;
        --warning: #ffad1f;
        --error: #f4212e;
        --border: #2f3336;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
        background: var(--bg-dark);
        color: var(--text-primary);
        min-height: 100vh;
      }
      .header {
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .logo {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .logo span {
        color: var(--accent);
      }
      .nav-links {
        display: flex;
        gap: 16px;
      }
      .nav-links a {
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-decoration: none;
        padding: 4px 0;
        transition: color 0.2s;
      }
      .nav-links a:hover {
        color: var(--text-primary);
      }
      .nav-links a.active {
        color: var(--accent);
        font-weight: 600;
        border-bottom: 2px solid var(--accent);
      }
      .user-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .user-name {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      .logout-btn {
        padding: 8px 16px;
        font-size: 0.875rem;
        color: var(--text-primary);
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .logout-btn:hover {
        background: var(--bg-hover);
      }
      .main {
        max-width: 900px;
        margin: 0 auto;
        padding: 24px;
      }
      h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 24px;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
      }
      .tab {
        padding: 10px 20px;
        font-size: 0.875rem;
        color: var(--text-secondary);
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab.active {
        color: var(--bg-dark);
        background: var(--accent);
        border-color: var(--accent);
      }
      .tab:hover:not(.active) {
        background: var(--bg-hover);
        color: var(--text-primary);
      }
      .share-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .share-item {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        transition: background 0.2s;
      }
      .share-item:hover {
        background: var(--bg-hover);
      }
      .share-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      .share-name {
        font-size: 1rem;
        font-weight: 500;
      }
      .share-status {
        padding: 4px 10px;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 4px;
      }
      .status-pending {
        background: rgba(255, 173, 31, 0.15);
        color: var(--warning);
      }
      .status-accepted {
        background: rgba(0, 186, 124, 0.15);
        color: var(--success);
      }
      .status-declined {
        background: rgba(244, 33, 46, 0.15);
        color: var(--error);
      }
      .share-meta {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }
      .share-actions {
        display: flex;
        gap: 8px;
      }
      .action-btn {
        padding: 8px 16px;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-accept {
        color: var(--bg-dark);
        background: var(--success);
        border: none;
      }
      .btn-accept:hover {
        background: #00a870;
      }
      .btn-decline {
        color: var(--error);
        background: transparent;
        border: 1px solid var(--error);
      }
      .btn-decline:hover {
        background: rgba(244, 33, 46, 0.1);
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
      }
      .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
      }
      .protocol-details {
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        overflow-x: auto;
      }
      .protocol-json {
        white-space: pre-wrap;
        word-break: break-all;
        font-family: "SF Mono", "Fira Code", monospace;
        font-size: 0.8125rem;
        color: var(--text-secondary);
      }
      .verify-result {
        padding: 10px 14px;
        margin-top: 8px;
        font-size: 0.875rem;
        border-radius: 6px;
        white-space: pre-wrap;
      }
      .verify-result.success {
        color: var(--success);
        background: rgba(0, 186, 124, 0.1);
        border: 1px solid var(--success);
      }
      .verify-result.error {
        color: var(--error);
        background: rgba(244, 33, 46, 0.1);
        border: 1px solid var(--error);
      }
      .btn-details,
      .btn-verify {
        color: var(--text-primary);
        background: transparent;
        border: 1px solid var(--border);
      }
      .trace-panel {
        position: sticky;
        bottom: 0;
      }
      .trace-header {
        cursor: pointer;
        padding: 8px 16px;
        background: var(--bg-card);
        border-top: 1px solid var(--border);
        font-size: 0.875rem;
        font-weight: 500;
      }
      .trace-body {
        max-height: 200px;
        overflow-y: auto;
        background: var(--bg-dark);
        padding: 8px;
      }
      .trace-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .trace-entry {
        font-family: "SF Mono", "Fira Code", monospace;
        font-size: 0.8125rem;
        padding: 2px 8px;
        line-height: 1.4;
      }
      .trace-time {
        color: var(--text-secondary);
      }
      .trace-type {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="logo">Open<span>Cloud</span>Mesh</div>
      <nav class="nav-links">
        <a href="ui/inbox" class="active">Inbox</a>
        <a href="ui/outgoing">Outgoing</a>
      </nav>
      <div class="user-info">
        <span class="user-name" id="user-name">Loading...</span>
        <button class="logout-btn" id="logout-btn">Sign Out</button>
      </div>
    </header>
    <main class="main">
      <h2>Shared with Me</h2>
      <div class="tabs" id="share-tabs">
        <button class="tab active" data-filter="all">All</button>
        <button class="tab" data-filter="pending">Pending</button>
        <button class="tab" data-filter="accepted">Accepted</button>
      </div>
      <div class="share-list" id="share-list">
        <div class="empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
            />
          </svg>
          <p>No shares yet</p>
        </div>
      </div>

      <h2 style="margin-top: 40px;">Federation Invites</h2>
      <div class="tabs" id="invite-tabs">
        <button class="tab active" data-filter="all">All</button>
        <button class="tab" data-filter="pending">Pending</button>
        <button class="tab" data-filter="accepted">Accepted</button>
      </div>
      <div class="share-list" id="invite-list">
        <div class="empty-state">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="1.5"
              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
            />
          </svg>
          <p>No invites yet</p>
        </div>
      </div>
      <div class="trace-panel" id="protocol-trace">
        <div class="trace-header" onclick="toggleTracePanel()">
          Protocol Trace <span id="trace-count">(0)</span>
        </div>
        <div class="trace-body" id="protocol-trace-body" style="display:none;">
          <div id="protocol-trace-list" class="trace-list"></div>
        </div>
      </div>
    </main>
    <script>
      let allShares = [];
      let allInvites = [];
      let currentFilter = "all";
      let currentInviteFilter = "all";
      const detailsCache = {};

      class ProtocolTrace {
        constructor(maxEntries = 50) {
          this.maxEntries = maxEntries;
          this.entries = [];
        }
        add(entry) {
          this.entries.push({ timestamp: new Date().toISOString(), ...entry });
          if (this.entries.length > this.maxEntries) this.entries.shift();
          this.render();
          const countEl = document.getElementById("trace-count");
          if (countEl) countEl.textContent = "(" + this.entries.length + ")";
        }
        render() {
          const container = document.getElementById("protocol-trace-list");
          if (!container) return;
          container.innerHTML = this.entries.slice().reverse()
            .map(e => '<div class="trace-entry trace-' + e.type + '">'
              + '<span class="trace-time">' + e.timestamp.split("T")[1].split(".")[0] + '</span> '
              + '<span class="trace-type">' + e.type + '</span> '
              + '<span class="trace-detail">' + escapeHtml(e.detail) + '</span>'
              + '</div>').join("");
        }
      }
      const trace = new ProtocolTrace(50);

      function toggleTracePanel() {
        const body = document.getElementById("protocol-trace-body");
        if (body) body.style.display = body.style.display === "none" ? "block" : "none";
      }

      // Load user info
      fetch("api/auth/me", { credentials: "same-origin" })
        .then((r) => {
          if (!r.ok) throw new Error("not authenticated");
          return r.json();
        })
        .then((user) => {
          document.getElementById("user-name").textContent =
            user.display_name || user.username;
        })
        .catch(() => {
          window.location.href = "ui/login";
        });

      // Logout
      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          await fetch("api/auth/logout", {
            method: "POST",
            credentials: "same-origin",
          });
          window.location.href = "ui/login";
        });

      // Load shares
      async function loadShares() {
        try {
          const resp = await fetch("api/inbox/shares", { credentials: "same-origin" });
          if (!resp.ok) throw new Error("Failed to load shares");
          const data = await resp.json();
          allShares = data.shares || [];
          trace.add({ type: "share-received", detail: "Loaded " + allShares.length + " shares" });
          renderShares();
        } catch (err) {
          console.error("Failed to load shares:", err);
        }
      }

      // Render shares based on current filter
      function renderShares() {
        const list = document.getElementById("share-list");
        let filtered = allShares;

        if (currentFilter === "pending") {
          filtered = allShares.filter((s) => s.status === "pending");
        } else if (currentFilter === "accepted") {
          filtered = allShares.filter((s) => s.status === "accepted");
        }

        if (filtered.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <p>No shares yet</p>
            </div>
          `;
          return;
        }

        list.innerHTML = filtered
          .map(
            (share) => `
          <div class="share-item" data-share-id="${share.shareId}"${share.status === "accepted" ? ' data-test-resource-name="' + escapeAttr(share.name) + '"' : ""}>
            <div class="share-header">
              <div class="share-name">${escapeHtml(share.name)}</div>
              <span class="share-status status-${share.status}">${share.status}</span>
            </div>
            <div class="share-meta">
              From: ${escapeHtml(share.sender || share.owner)} | Type: ${escapeHtml(share.resourceType)}
            </div>
            <button class="action-btn btn-details" data-ocm-action="toggle-protocol-details"
                    onclick="toggleProtocolDetails('${share.shareId}')">
              Protocol Details
            </button>
            <div class="protocol-details" data-ocm-field="protocol-details"
                 id="protocol-details-${share.shareId}" style="display:none;">
              <pre class="protocol-json">Loading...</pre>
            </div>
            ${share.status === "accepted" ? `
              <button class="action-btn btn-verify" data-ocm-action="verify-access"
                      onclick="verifyAccess('${share.shareId}')">
                Verify Access
              </button>
              <div class="verify-result" data-ocm-field="verify-access-result"
                   id="verify-result-${share.shareId}" style="display:none;"></div>
            ` : ""}
            ${share.status === "pending" ? `
              <div class="share-actions">
                <button class="action-btn btn-accept" onclick="acceptShare('${share.shareId}')">Accept</button>
                <button class="action-btn btn-decline" onclick="declineShare('${share.shareId}')">Decline</button>
              </div>
            ` : ""}
          </div>
        `
          )
          .join("");
      }

      // Accept share
      async function acceptShare(shareId) {
        try {
          const resp = await fetch("api/inbox/shares/" + shareId + "/accept", {
            method: "POST",
            credentials: "same-origin",
          });
          if (!resp.ok) throw new Error("Failed to accept share");
          await loadShares();
          trace.add({ type: "share-accepted", detail: "Accepted share " + shareId });
        } catch (err) {
          alert("Failed to accept share: " + err.message);
        }
      }

      // Decline share
      async function declineShare(shareId) {
        try {
          const resp = await fetch("api/inbox/shares/" + shareId + "/decline", {
            method: "POST",
            credentials: "same-origin",
          });
          if (!resp.ok) throw new Error("Failed to decline share");
          await loadShares();
          trace.add({ type: "share-declined", detail: "Declined share " + shareId });
        } catch (err) {
          alert("Failed to decline share: " + err.message);
        }
      }

      // Escape HTML to prevent XSS
      function escapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function escapeAttr(str) {
        return escapeHtml(str).replace(/"/g, "&quot;");
      }

      // Toggle protocol details for a share (lazy-fetched, cached)
      async function toggleProtocolDetails(shareId) {
        const container = document.getElementById("protocol-details-" + shareId);
        if (!container) return;
        if (container.style.display !== "none") {
          container.style.display = "none";
          return;
        }

        container.style.display = "block";
        const pre = container.querySelector(".protocol-json");
        if (detailsCache[shareId]) {
          pre.textContent = JSON.stringify(detailsCache[shareId].protocol, null, 2);
          return;
        }

        try {
          const resp = await fetch("api/inbox/shares/" + shareId, {
            credentials: "same-origin",
          });
          if (resp.status === 401) {
            window.location.href = "ui/login";
            return;
          }
          if (!resp.ok) throw new Error("Failed to load details");
          const data = await resp.json();
          detailsCache[shareId] = data;
          pre.textContent = JSON.stringify(data.protocol, null, 2);
        } catch (err) {
          pre.textContent = "Error: " + err.message;
        }
      }

      // Verify WebDAV access for an accepted share
      async function verifyAccess(shareId) {
        const container = document.getElementById("verify-result-" + shareId);
        if (!container) return;
        container.style.display = "block";
        container.className = "verify-result";
        container.textContent = "Verifying...";

        try {
          const resp = await fetch("api/inbox/shares/" + shareId + "/verify-access", {
            method: "POST",
            credentials: "same-origin",
          });
          if (resp.status === 401) {
            window.location.href = "ui/login";
            return;
          }
          const data = await resp.json();
          if (data.ok) {
            container.classList.add("success");
            let text = "OK -- " + data.methodUsed + " (HTTP " + data.httpStatus + ")";
            if (data.contentPreview) {
              text += "\nPreview: " + data.contentPreview.substring(0, 200);
              if (data.contentPreviewTruncated) text += "...";
            }
            container.textContent = text;
          } else {
            container.classList.add("error");
            container.textContent = "Failed: " + (data.error || "unknown error") + " (" + (data.reasonCode || "unknown") + ")";
          }
          trace.add({ type: "verify-access", detail: "Verify " + shareId + ": " + (data.ok ? "OK" : "Failed") });
        } catch (err) {
          container.classList.add("error");
          container.textContent = "Network error: " + err.message;
        }
      }

      // Tab filtering
      document.querySelectorAll("#share-tabs .tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll("#share-tabs .tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentFilter = tab.dataset.filter;
          renderShares();
        });
      });

      // Load invites
      async function loadInvites() {
        try {
          const resp = await fetch("api/inbox/invites", { credentials: "same-origin" });
          if (!resp.ok) throw new Error("Failed to load invites");
          const data = await resp.json();
          allInvites = data.invites || [];
          renderInvites();
        } catch (err) {
          console.error("Failed to load invites:", err);
        }
      }

      // Render invites based on current filter
      function renderInvites() {
        const list = document.getElementById("invite-list");
        let filtered = allInvites;

        if (currentInviteFilter === "pending") {
          filtered = allInvites.filter((i) => i.status === "pending");
        } else if (currentInviteFilter === "accepted") {
          filtered = allInvites.filter((i) => i.status === "accepted");
        }

        if (filtered.length === 0) {
          list.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg><p>No invites yet</p></div>';
          return;
        }

        list.innerHTML = filtered
          .map(
            (invite) => '<div class="share-item invite-item" data-invite-id="' + invite.id + '"' +
              (invite.status === "accepted" ? ' data-test-invite-sender="' + escapeAttr(invite.senderFqdn) + '"' : '') + '>' +
              '<div class="share-header">' +
                '<div class="share-name">Invite from ' + escapeHtml(invite.senderFqdn) + '</div>' +
                '<span class="share-status status-' + invite.status + '">' + invite.status + '</span>' +
              '</div>' +
              '<div class="share-meta">Received: ' + new Date(invite.receivedAt).toLocaleDateString() + '</div>' +
              (invite.status === "pending"
                ? '<div class="share-actions">' +
                    '<button class="action-btn btn-accept" onclick="acceptInvite(\'' + invite.id + '\')">Accept</button>' +
                    '<button class="action-btn btn-decline" onclick="declineInvite(\'' + invite.id + '\')">Decline</button>' +
                  '</div>'
                : "") +
            '</div>'
          )
          .join("");
      }

      // Accept invite
      async function acceptInvite(inviteId) {
        try {
          const resp = await fetch("api/inbox/invites/" + inviteId + "/accept", {
            method: "POST",
            credentials: "same-origin",
          });
          if (!resp.ok) throw new Error("Failed to accept invite");
          await loadInvites();
          trace.add({ type: "invite-accepted", detail: "Accepted invite " + inviteId });
        } catch (err) {
          alert("Failed to accept invite: " + err.message);
        }
      }

      // Decline invite
      async function declineInvite(inviteId) {
        try {
          const resp = await fetch("api/inbox/invites/" + inviteId + "/decline", {
            method: "POST",
            credentials: "same-origin",
          });
          if (!resp.ok) throw new Error("Failed to decline invite");
          await loadInvites();
        } catch (err) {
          alert("Failed to decline invite: " + err.message);
        }
      }

      // Invite tab filtering
      document.querySelectorAll("#invite-tabs .tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll("#invite-tabs .tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentInviteFilter = tab.dataset.filter;
          renderInvites();
        });
      });

      // Load shares and invites on page load
      loadShares();
      loadInvites();
    </script>
  </body>
</html>
